#!/bin/bash

#set -o errexit   # is more harmful than useful
                  # http://mywiki.wooledge.org/BashFAQ/105
                  # http://wiki.bash-hackers.org/scripting/obsolete
                  # https://github.com/yaccz/errexit-considered-harmful
#set -o nounset   # bad practice
set -o pipefail   # set the return value of a pipeline to the value of the rightmost
                  # command to exit with a non-zero status, or zero if all commands
                  # in the pipeline exit successfully.
shopt -s nullglob

_script_dir="$( cd "$(dirname "$0")" && pwd -P )" || exit 1
_confirm=1
_verbose=0

for _lib in "$_script_dir"/lib/*.sh; do
    # shellcheck disable=SC1090
    . "$_lib" || exit 1
done

_args=()

while (( $# > 0 )); do
    case "$1" in
        -*)
            ;;
        -n|--noconfirm)
            _confirm=0
            ;;
        -v|--verbose)
            _verbose=1
            ;;
        --help|--*|-*)
            echo "Usage: $0 [OPTIONS] [SCRIPT...]"
            echo "Options:"
            echo " --help           show this message"
            echo " -n, --noconfirm  do not ask for any confirmation"
            echo " -v, --verbose    show the action that made no change"
            exit 1
            ;;
        *)
            _args+=("$1")
            ;;
    esac
    shift
done

if (( ${#_args[@]} == 0 )); then
    _scripts=("$_script_dir"/*.df.sh "$_script_dir"/*/main.df.sh)
else
    for _arg in "${_args[@]}"; do
        _arg_full="$_script_dir/$_arg"

        if [[ -e $_arg_full/main.df.sh ]]; then
            _script="$_arg_full/main.df.sh"
        else
            _script="${_arg_full}.df.sh"
        fi

        if [[ ! -e $_script ]]; then
            echo "error: script $_script not found" >&2
            exit 1
        fi

        _scripts+=("$_script")
    done
fi

for _script in "${_scripts[@]}"; do
    if [[ $_script =~ /main\.sh$ ]]; then
        _script_name="$(basename "$(dirname "$_script")")"
    else
        _script_name="${_script%.df.sh}"
    fi

    # shellcheck disable=SC1090
    (cd "$(dirname "$_script")" && . "$_script") || exit 1
done
