#!/bin/bash

#set -o errexit   # is more harmful than useful
                  # http://mywiki.wooledge.org/BashFAQ/105
                  # http://wiki.bash-hackers.org/scripting/obsolete
                  # https://github.com/yaccz/errexit-considered-harmful
#set -o nounset   # bad practice
set -o pipefail   # set the return value of a pipeline to the value of the rightmost
                  # command to exit with a non-zero status, or zero if all commands
                  # in the pipeline exit successfully.
shopt -s nullglob

_script_dir="$( cd "$(dirname "$0")" && pwd -P )" || exit 1
_confirm=true
df_verbose=false

for df_lib in "$_script_dir"/lib/*.sh; do
    # shellcheck disable=SC1090
    . "$df_lib" || exit 1
done

df_args=()

while (( $# > 0 )); do
    case "$1" in
        -n|--noconfirm)
            _confirm=false
            ;;
        -v|--verbose)
            df_verbose=true
            ;;
        --help|--*|-*)
            echo "Usage: $0 [OPTIONS] [SCRIPT...]"
            echo "Options:"
            echo " --help           show this message"
            echo " -n, --noconfirm  do not ask for any confirmation"
            echo " -v, --verbose    show the action that made no change"
            exit 1
            ;;
        *)
            df_args+=("$1")
            ;;
    esac
    shift
done

if (( ${#df_args[@]} == 0 )); then
    df_scripts=("$_script_dir"/*.df.sh "$_script_dir"/*/main.df.sh)
else
    for df_arg in "${df_args[@]}"; do
        df_arg_full="$_script_dir/$df_arg"

        if [[ -e $df_arg_full/main.df.sh ]]; then
            df_script="$df_arg_full/main.df.sh"
        else
            df_script="${df_arg_full}.df.sh"
        fi

        if [[ ! -e $df_script ]]; then
            echo "error: script $df_script not found" >&2
            exit 1
        fi

        df_scripts+=("$df_script")
    done
fi

for df_script in "${df_scripts[@]}"; do
    if [[ $df_script =~ /main\.sh$ ]]; then
        df_script_name="$(basename "$(dirname "$df_script")")"
    else
        df_script_name="${df_script%.df.sh}"
    fi

    # shellcheck disable=SC1090
    (cd "$(dirname "$df_script")" && . "$df_script") || exit 1
done
